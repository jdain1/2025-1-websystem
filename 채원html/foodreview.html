<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>리뷰 작성</title>
    <link rel="stylesheet" href="../css/review.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div id="container">
        <h1>리뷰작성</h1>
        <p>별점과 한줄 리뷰를 등록해주세요.</p>
        <div><strong>⭐ 평균 별점: <span id="averageRating">0</span></strong></div>
        <br>
        <div class="star_rating">
            <input type="hidden" id="rating" value="1">
            <span class="star on" data-value="1"></span>
            <span class="star" data-value="2"></span>
            <span class="star" data-value="3"></span>
            <span class="star" data-value="4"></span>
            <span class="star" data-value="5"></span>
        </div>
        <br>
        <input type="text" id="subject" placeholder="한줄 리뷰를 입력하세요" autofocus>
        <button onclick="newRegister(); return false;">등록</button>
        <hr>
        <ul id="itemList"></ul>
    </div>

    <script>
        let reviews = [];
        let currentUser = getCurrentUser();

        function getCurrentUser() {
            const name = document.cookie.split(';').find(c => c.trim().startsWith('currentUser='));
            return name ? decodeURIComponent(name.split('=')[1]) : null;
        }

        $('.star').click(function () {
            let rating = $(this).data('value');
            $('#rating').val(rating);
            $('.star').removeClass('on');
            $(this).addClass('on').prevAll().addClass('on');
        });

        window.onload = function () {
            if (!currentUser) {
                alert("로그인이 필요합니다.");
                window.location.href = "login.html";
                return;
            }

            const stored = localStorage.getItem("reviews_" + currentUser);
            if (stored) {
                reviews = JSON.parse(stored);
                reviews.forEach(r => renderReview(r.rating, r.text, r.author));
                updateAverage();
            }
        };

        function newRegister() {
            let subject = document.querySelector("#subject");
            let comment = subject.value.trim();
            let rating = parseInt(document.querySelector("#rating").value);

            if (!comment) {
                alert("리뷰 내용을 입력해주세요.");
                return;
            }

            const review = {
                rating: rating,
                text: comment,
                author: currentUser
            };
            reviews.push(review);
            localStorage.setItem("reviews_" + currentUser, JSON.stringify(reviews));
            renderReview(rating, comment, currentUser);
            updateAverage();

            subject.value = "";
            document.querySelector("#rating").value = 1;
            $(".star").removeClass("on");
            $(".star").eq(0).addClass("on");
        }

        function renderReview(rating, comment, author) {
            let newItem = document.createElement("li");
            newItem.className = "review-item";

            let ratingSpan = document.createElement("span");
            ratingSpan.className = "review-rating";
            ratingSpan.textContent = `${rating}점`;

            let reviewSpan = document.createElement("span");
            reviewSpan.className = "review-text";
            reviewSpan.textContent = `${comment} (${author})`;

            let delBtn = document.createElement("button");
            delBtn.className = "delete-btn";
            delBtn.textContent = "삭제";

            if (author === currentUser) {
                delBtn.onclick = function () {
                    let index = reviews.findIndex(r => r.text === comment && r.author === currentUser && r.rating === rating);
                    if (index > -1) {
                        reviews.splice(index, 1);
                        localStorage.setItem("reviews_" + currentUser, JSON.stringify(reviews));
                    }
                    itemList.removeChild(newItem);
                    updateAverage();
                };
            } else {
                delBtn.disabled = true;
                delBtn.style.opacity = 0.5;
            }

            newItem.appendChild(ratingSpan);
            newItem.appendChild(reviewSpan);
            newItem.appendChild(delBtn);

            let itemList = document.querySelector("#itemList");
            itemList.appendChild(newItem);
        }

        function updateAverage() {
            if (reviews.length === 0) {
                document.querySelector("#averageRating").textContent = "0";
                return;
            }
            let sum = reviews.reduce((acc, r) => acc + r.rating, 0);
            let avg = (sum / reviews.length).toFixed(1);
            document.querySelector("#averageRating").textContent = avg;
        }
    </script>
</body>
</html>
