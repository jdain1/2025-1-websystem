<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>리뷰 작성</title>
    <style>
        ul {
            list-style: none;
            padding: 0;
        }
        .star_rating {
            display: flex;
        }
        .star {
            width: 25px;
            height: 25px;
            margin-right: 5px;
            background: url('bstar.png') no-repeat center;
            background-size: cover;
            cursor: pointer;
        }
        .star.on {
            background: url('ystar.png') no-repeat center;
            background-size: cover;
        }
        .review-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ccc;
        }
        .review-rating {
            width: 80px;
            font-weight: bold;
        }
        .review-text {
            flex-grow: 1;
            padding: 0 10px;
        }
        .delete-btn {
            background: lightgray;
            border: none;
            cursor: pointer;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div id="container">
        <h1>리뷰작성</h1>
        <p>별점과 한줄 리뷰를 등록해주세요.</p>
        <div><strong>⭐ 평균 별점: <span id="averageRating">0</span></strong></div>
        <br>
        <div class="star_rating">
            <input type="hidden" id="rating" value="1">
            <span class="star on" data-value="1"></span>
            <span class="star" data-value="2"></span>
            <span class="star" data-value="3"></span>
            <span class="star" data-value="4"></span>
            <span class="star" data-value="5"></span>
        </div>
        <br>
        <input type="text" id="subject" placeholder="한줄 리뷰를 입력하세요" autofocus>
        <button onclick="newRegister(); return false;">등록</button>
        <hr>
        <ul id="itemList"></ul>
    </div>

    <script>
        let reviews = [];

        // 별점 선택 처리
        $('.star').click(function () {
            let rating = $(this).data('value');
            $('#rating').val(rating);
            $('.star').removeClass('on');
            $(this).addClass('on').prevAll().addClass('on');
        });

        // 페이지 로드시 저장된 데이터 불러오기
        window.onload = function () {
            const stored = localStorage.getItem("reviews");
            if (stored) {
                reviews = JSON.parse(stored);
                reviews.forEach(r => renderReview(r.rating, r.text));
                updateAverage();
            }
        };

        function newRegister() {
            let subject = document.querySelector("#subject");
            let comment = subject.value.trim();
            let rating = parseInt(document.querySelector("#rating").value);

            if (!comment) {
                alert("리뷰 내용을 입력해주세요.");
                return;
            }

            const review = { rating: rating, text: comment };
            reviews.push(review);
            localStorage.setItem("reviews", JSON.stringify(reviews));
            renderReview(rating, comment);
            updateAverage();

            // 입력 초기화
            subject.value = "";
            document.querySelector("#rating").value = 1;
            $(".star").removeClass("on");
            $(".star").eq(0).addClass("on");
        }

        function renderReview(rating, comment) {
            let newItem = document.createElement("li");
            newItem.className = "review-item";

            let ratingSpan = document.createElement("span");
            ratingSpan.className = "review-rating";
            ratingSpan.textContent = `${rating}점`;

            let reviewSpan = document.createElement("span");
            reviewSpan.className = "review-text";
            reviewSpan.textContent = comment;

            let delBtn = document.createElement("button");
            delBtn.className = "delete-btn";
            delBtn.textContent = "삭제";

            delBtn.onclick = function () {
                let index = Array.from(itemList.children).indexOf(newItem);
                if (index > -1) {
                    reviews.splice(index, 1);
                    localStorage.setItem("reviews", JSON.stringify(reviews));
                }
                itemList.removeChild(newItem);
                updateAverage();
            };

            newItem.appendChild(ratingSpan);
            newItem.appendChild(reviewSpan);
            newItem.appendChild(delBtn);

            let itemList = document.querySelector("#itemList");
            itemList.appendChild(newItem);
        }

        function updateAverage() {
            if (reviews.length === 0) {
                document.querySelector("#averageRating").textContent = "0";
                return;
            }
            let sum = reviews.reduce((acc, r) => acc + r.rating, 0);
            let avg = (sum / reviews.length).toFixed(1);
            document.querySelector("#averageRating").textContent = avg;
        }
    </script>
</body>
</html>
